<!--By Kovi Bodek, 2018-2019-->
<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="minimal-ui,width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<script>
var ctx;
var G = 12;
var spawning = false;
var spawnlocation = [];
var spawnsize = 5;
var deadtraces = [];
var com = [100,100];
var shift = [0,0];
var scale = 1;
var newscale = 1;
var tutorial = false;
var tutorialtimer = 0;
var PAUSE = false;
var maxd = 0;
var velocity_animation = 0;
var menu_animation = 0;
var menu = [null, null];
var menuitem = 0;
var mousedown = false;
var newcom = [0,0]
var clickTimer = 10000;

colors = ["#8E44AD","#3498DB","#C0392B","#F1C40F","#1ABC9C","#FFFFFF","#34495E","#F1948A","#2ECC71","#DC7633","#DC7633"]

function startGame() {
    planets = [];
    planets[0]=new planet(300,300,1000,-.05,0,"#00FF00");
    planets[1]=new planet(300,660,50,5,0,"#00FFFF");
    planets[2]=new planet(300,685,5,10,0)
    controls = new button(10,10,150,50,"#C0392B","View Controls")
    source = new button(170,10,150,50,"#8E44AD","View Source")
    area.start();
}

var area = {
    start : function() {
        WIDTH = document.getElementById("GameCanvas").width;
        HEIGHT = document.getElementById("GameCanvas").height;
        ctx = document.getElementById("GameCanvas").getContext("2d");
        this.interval = setInterval(updateGameArea, 10);
        window.addEventListener('keydown', function (e) {
            pressed(e.keyCode)
            area.keys = (area.keys || []);
            area.keys[e.keyCode] = true;
        })
        window.addEventListener('keyup', function (e) {
            area.keys[e.keyCode] = false;
        })
        window.addEventListener('mousedown', function (e) {
            if (tutorial==false){
                mousedown = true;
                onClick();
            }
            else tutorial = false;
        })
        window.addEventListener('mouseup', function (e) {
            mousedown = false;
            unClick();
        })
        window.addEventListener('mousemove', function (e) {
            area.x = e.pageX;
            area.y = e.pageY;
        })
        window.addEventListener('contextmenu', function (e){
            e.preventDefault();
            rightClick();
        })
    }, 
    clear : function(){
        document.getElementById("GameCanvas").width  = window.innerWidth;
        document.getElementById("GameCanvas").height = window.innerHeight;
        WIDTH = document.getElementById("GameCanvas").width;
        HEIGHT = document.getElementById("GameCanvas").height
        ctx.clearRect(0, 0, WIDTH, HEIGHT);
    }
}

function button(x, y, w, h, color,text){
    this.x=x;
    this.y=y;
    this.w=w;
    this.h=h;
    this.color=color;
    this.text = text;
    this.alpha = 1;
    this.hover=false;
    this.draw = function(){
        ctx.fillStyle = this.color;
        ctx.strokeStyle = averageColor(color, "#000000");
        if (this.hover)this.alpha=(this.alpha*5+1)/6;
        else this.alpha = 0.3;
        ctx.globalAlpha = this.alpha;
        ctx.roundRect(this.x,this.y,this.w,this.h,5,true);
        ctx.globalAlpha = 1;
        ctx.font = "20px Arial";
        ctx.fillStyle = averageColor(color, "#FFFFFF");
        ctx.fillText(text, this.x+15, this.y+30);
    }
    this.update = function(){
        if(area.x>this.x&&area.x<this.x+this.w&&area.y>this.y&&area.y<this.y+this.h){
            this.hover=true;
            if (mousedown)return true;
        }
        else this.hover=false;
        return false;
    }
}

function planet(x, y, mass, xv, yv, color, startradius){
    this.x = x;
    this.y = y;
    this.xv = xv || 0;
    this.yv = yv || 0;
    this.mass = mass || 50;
    this.color = color || "#ffffff"
    this.tracecolor = alpha(this.color, 0.5)
    this.tr = Math.pow(this.mass,0.5)
    this.r = startradius || this.tr
    this.trace = [];
    this.draw = function(){
        this.r = (this.tr+this.r*19)/20

        ctx.fillStyle = (this.color);
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.arc(this.x*scale+shift[0],this.y*scale+shift[1],this.r*scale,0,Math.PI*2);
        ctx.fill();
        
        if (this.trace.length>2){
            ctx.strokeStyle = this.tracecolor
            ctx.lineWidth = 3;
            ctx.beginPath();

            ctx.moveTo(this.trace[0][0]*scale+shift[0],this.trace[0][1]*scale+shift[1])
            for(x=1;x<this.trace.length;x++)ctx.lineTo(this.trace[x][0]*scale+shift[0],this.trace[x][1]*scale+shift[1]);
            ctx.stroke();
        }
        if (PAUSE){
            ctx.strokeStyle = "#00FF00";
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(this.x*scale+shift[0],this.y*scale+shift[1]);
            ctx.lineTo(this.x*scale+shift[0]+this.xv*40*velocity_animation*Math.pow(scale,0.5),this.y*scale+shift[1]+this.yv*40*velocity_animation*Math.pow(scale,0.5));
            ctx.stroke();
        }
    }
    this.update = function(){
        for (x=0;x<planets.length;x++){
            if (planets[x]==this)continue;
            dx = planets[x].x-this.x;
            dy = planets[x].y-this.y;
            d = Math.sqrt(dx*dx+dy*dy);
            if (d<this.r+planets[x].r){
                startradius = 0;
                if (this.r>planets[x].r)startradius=this.r;
                else startradius = planets[x].r;
                planets.push(new planet(
                    (this.x*this.mass+planets[x].x*planets[x].mass)/(this.mass+planets[x].mass), 
                    (this.y*this.mass+planets[x].y*planets[x].mass)/(this.mass+planets[x].mass), 
                    this.mass+planets[x].mass, 
                    (planets[x].mass*planets[x].xv+this.mass*this.xv)/(this.mass+planets[x].mass),
                    (planets[x].mass*planets[x].yv+this.mass*this.yv)/(this.mass+planets[x].mass),
                    averageColor(planets[x].color,this.color, planets[x].mass, this.mass),
                    startradius
                    ))

                deadtraces.push(planets.splice(x, 1)[0].trace);
                deadtraces.push(planets.splice(planets.indexOf(this), 1)[0].trace);
                planets[planets.length-1].update();
                return;
            }
            if (Math.abs(d)>1){
                this.xv += dx*planets[x].mass*G/d**3;
                this.yv += dy*planets[x].mass*G/d**3;           
            }
        }
        
    }
    this.move = function(){
        this.x+=this.xv;
        this.y+=this.yv;
        if (this.trace.length>500)this.trace.pop();
        this.trace.unshift([this.x,this.y]);
        this.draw();
    }
}
function drawCursor() {
    if (area.x!=null){
        ctx.strokeStyle = "#FF9900";
        ctx.lineWidth = 2;
        ctx.beginPath();
        if (area.keys && area.keys[16] && !spawning){
            ctx.arc(area.x,area.y,spawnsize*scale,0,Math.PI*2);
            if (area.keys && area.keys[38] && spawnsize<300)spawnsize*=1.05;
            if (area.keys && area.keys[40] && spawnsize>3)spawnsize/=1.05;
        }
        else{
            ctx.moveTo(area.x,area.y-10);
            ctx.lineTo(area.x,area.y+10);
            ctx.moveTo(area.x-10,area.y);
            ctx.lineTo(area.x+10,area.y);
        }
        ctx.stroke();
    }
}
function onClick(){
    if (area.keys && area.keys[16] && area.x!=null){
        spawnlocation[0] = area.x;
        spawnlocation[1] = area.y;
        spawning = true;
        clickTimer=51;
    }
    if (menu[0]!=null){
        if (area.x<menu[0]||area.x>menu[0]+200||area.y<menu[1]-300||area.y>menu[1])menu = [null, null];
        else{
            if (menuitem==0){
                planets.splice(planets.indexOf(selectedplanet),1);
                menu = [null,null];
                newcom = centerOfMass();
                resetScale();

            }

        }
        clickTimer=51;
    }
    else if (clickTimer<50&&PAUSE){
        doubleClick();
        clickTimer = 51;
    }
    else clickTimer = 0;
}
function doubleClick(){
    newscale*=6;
    newcom = [(area.x-shift[0])/scale - (area.x-WIDTH/2)/newscale, (area.y-shift[1])/scale - (area.y-HEIGHT/2)/newscale]
    //newcom = [(area.x-shift[0])/scale, (area.y-shift[1])/scale]
}
function rightClick(){
    if (PAUSE){
        for (x=0;x<planets.length;x++){
            if ((((planets[x].x*scale+shift[0])-area.x)**2+((planets[x].y*scale+shift[1])-area.y)**2)**0.5<planets[x].r*scale+3){
                selectedplanet = planets[x];
                menu = [area.x,area.y]
                menu_animation = 0;
                menuitem = -1;
                PAUSE = true;
            }
        }
    }
}
function alpha(color, factor){
    r = Math.round(parseInt(color.substring(1,3), 16)*factor).toString(16)
    g = Math.round(parseInt(color.substring(3,5), 16)*factor).toString(16)
    b = Math.round(parseInt(color.substring(5,7), 16)*factor).toString(16)
    if (r.length<2)r="0"+r;
    if (g.length<2)g="0"+g;
    if (b.length<2)b="0"+b;
    return ("#" + r + g + b)
}
function averageColor(color1, color2, w1, w2){
    weight1 = w1 || 1;
    weight2 = w2 || 1;
    r = Math.round((parseInt(color1.substring(1,3), 16)*weight1+parseInt(color2.substring(1,3), 16)*weight2)/(weight1+weight2)).toString(16);
    g = Math.round((parseInt(color1.substring(3,5), 16)*weight1+parseInt(color2.substring(3,5), 16)*weight2)/(weight1+weight2)).toString(16);
    b = Math.round((parseInt(color1.substring(5,7), 16)*weight1+parseInt(color2.substring(5,7), 16)*weight2)/(weight1+weight2)).toString(16);
    if (r.length<2)r="0"+r;
    if (g.length<2)g="0"+g;
    if (b.length<2)b="0"+b;
    console.log("#"+r+g+b)
    return ("#" + r + g + b)
}
function drawArrow(){
    ctx.strokeStyle = "#FF3300";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(spawnlocation[0],spawnlocation[1],spawnsize*scale,0,Math.PI*2);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(spawnlocation[0],spawnlocation[1]);
    ctx.lineTo(area.x,area.y)
    ctx.stroke();
}
function unClick(){
    if (spawning && area.keys && area.keys[16]){
        spawning = false;
        if (area.x!=null)planets.push(new planet((spawnlocation[0]-shift[0])/scale,(spawnlocation[1]-shift[1])/scale, Math.pow(spawnsize, 2), (area.x-spawnlocation[0])/(40*Math.pow(scale,0.5)), (area.y-spawnlocation[1])/(40*Math.pow(scale,0.5)),colors[Math.floor(Math.random() * colors.length)],1))
            newcom = centerOfMass();
            resetScale();
    }
}
function centerOfMass(){
    total = [0,0];
    if (planets.length==0)return total;
    totalmass = 0;
    for (x=0;x<planets.length;x++){
        total[0]+= planets[x].mass*planets[x].x
        total[1]+= planets[x].mass*planets[x].y
        totalmass+=planets[x].mass

    }
    total[0]/=totalmass;
    total[1]/=totalmass;
    return total;
}
function drawDeadTraces(){
    traceslength = deadtraces.length
    for (x=0;x<traceslength;x++){
        if (deadtraces[x].length < 3){
            deadtraces.splice(x,1);
            traceslength--;
            continue;
        }
        ctx.strokeStyle = "#FFFFFF";
        ctx.beginPath();
        ctx.moveTo(deadtraces[x][0][0]*scale+shift[0],deadtraces[x][0][1]*scale+shift[1]);
        for (i=1;i<deadtraces[x].length;i++)ctx.lineTo(deadtraces[x][i][0]*scale+shift[0],deadtraces[x][i][1]*scale+shift[1]);
        ctx.stroke();
        if (!PAUSE)deadtraces[x].pop();
    }
}
function drawGraph() {
    delta = 2**Math.round(Math.log2(1/scale))*100
    ctx.lineWidth = 1;
    ctx.strokeStyle = alpha("#FFFFFF",1-(Math.abs(Math.log2(1/scale)+2.5)%1))
    ctx.beginPath();
    for (x=-1*delta*scale/2;x<WIDTH+delta*scale;x+=(delta*scale)){
        ctx.moveTo(shift[0]%(delta*scale)+x,0);
        ctx.lineTo(shift[0]%(delta*scale)+x,HEIGHT);
    }
    for (y=-1*delta*scale/2;y<HEIGHT+delta*scale;y+=(delta*scale)){
        ctx.moveTo(0,shift[1]%(delta*scale)+y);
        ctx.lineTo(WIDTH,shift[1]%(delta*scale)+y);
    }
    ctx.stroke();
    ctx.strokeStyle = "#FFFFFF";
    ctx.lineWidth = 1;
    ctx.beginPath();
    for (x=0;x<WIDTH+delta*scale;x+=(delta*scale)){
        ctx.moveTo(shift[0]%(delta*scale)+x,0);
        ctx.lineTo(shift[0]%(delta*scale)+x,HEIGHT);
    }
    for (y=0;y<HEIGHT+delta*scale;y+=(delta*scale)){
        ctx.moveTo(0,shift[1]%(delta*scale)+y);
        ctx.lineTo(WIDTH,shift[1]%(delta*scale)+y);
    }
    ctx.stroke();
}
function resetScale(){
    maxd = 0;
    for (x=0;x<planets.length;x++){
        distance = (Math.sqrt(Math.pow(planets[x].x-newcom[0],2)+Math.pow(planets[x].y-newcom[1],2))+planets[x].r*3)
        if (distance>maxd)maxd = distance;
    }
    if (maxd>0)newscale = ((HEIGHT/2)/(maxd+100));
    else{
        newscale = 1;
    }
}
function drawMenu(){
    ctx.fillStyle = "#FFFFFF";
    ctx.fillRect(menu[0],menu[1]-300*menu_animation, 200*menu_animation, 300*menu_animation);
    
    ctx.fillStyle = "#0000FF";
    if (area.x>menu[0]&&area.x<menu[0]+200&&area.y>menu[1]-300&&area.y<menu[1]){
        menuitem = Math.ceil((menu[1]-area.y)/60)*-1+5;
        ctx.fillRect(menu[0], menu[1]-Math.ceil((menu[1]-area.y)/60)*60, 200, 60)
    }
    else menuitem = -1;
    if (menuitem==0)ctx.fillStyle = "#FFFFFF"
    else ctx.fillStyle = "#000000"
    ctx.font = "40px Arial";
    ctx.fillText("Delete",menu[0],menu[1]-260);


    ctx.strokeStyle = "#000000";
    ctx.lineWidth = 4;
    ctx.strokeRect(menu[0],menu[1]-300*menu_animation, 200*menu_animation, 300*menu_animation);
}

CanvasRenderingContext2D.prototype.roundRect = 
function(x, y, width, height, radius, fill, stroke) {
    if (typeof stroke == "undefined" ) {
    stroke = true;
    }
    if (typeof radius === "undefined") {
    radius = 5;
    }
    this.beginPath();
    this.moveTo(x + radius, y);
    this.lineTo(x + width - radius, y);
    this.quadraticCurveTo(x + width, y, x + width, y + radius);
    this.lineTo(x + width, y + height - radius);
    this.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
    this.lineTo(x + radius, y + height);
    this.quadraticCurveTo(x, y + height, x, y + height - radius);
    this.lineTo(x, y + radius);
    this.quadraticCurveTo(x, y, x + radius, y);
    this.closePath();
    if (stroke) {
    this.stroke();
    }
    if (fill) {
    this.fill();
    }        
}
function updateGameArea() {
    clickTimer++;
    if (maxd==0){
        com=[0,0];
        newscale = 1;
        deadtraces = [];
    }
    com  = [(newcom[0] - (newcom[0]-com[0])*(0.95)),(newcom[1] - (newcom[1]-com[1])*(0.95))]

    scale = (newscale - (newscale-scale)*0.95);
    shift = [WIDTH/2-com[0]*scale,HEIGHT/2-com[1]*scale]
    area.clear(); 
    if (!PAUSE){
        newcom = centerOfMass();
        for (x=0;x<planets.length;x++)planets[x].update();
        drawGraph();
        for (x=0;x<planets.length;x++)planets[x].move();
        resetScale();
    }
    else {
        drawGraph();
        for (x=0;x<planets.length;x++)planets[x].draw();
        velocity_animation = (1+velocity_animation*3)/4;
        menu_animation = (1+menu_animation*3)/4;
    }
    if (deadtraces.length>0)drawDeadTraces();
    if (!(area.keys && area.keys[16]))spawning=false;
    if (spawning)drawArrow();
    if (menu[0]!=null)drawMenu();
    if (!tutorial){
        tutorialtimer*=0.8;
        if (controls.update()){
            PAUSE = true;
            tutorial = true;
        }
        if(source.update())window.location.href = "gravitysource.txt";
    }
    controls.draw();
    source.draw();
    if (tutorialtimer>0.1||tutorial){
        if (tutorial){
            if (tutorialtimer<1)tutorialtimer=(tutorialtimer*3+1)/4;
            if (tutorialtimer>0.95)tutorialtimer=1;
        }
        ctx.globalAlpha = tutorialtimer/2;
        ctx.fillStyle = "#1ABC9C";
        ctx.rect(0, 0, WIDTH, HEIGHT);
        ctx.fill();
        ctx.globalAlpha = 1;


        ctx.fillStyle = "#00BFFF"
        ctx.strokeStyle = averageColor("#00BFFF", "#000000");
        ctx.roundRect(WIDTH/2-400*tutorialtimer,HEIGHT/2-200*tutorialtimer,800*tutorialtimer,400*tutorialtimer,5,true);

        ctx.globalAlpha = tutorialtimer**2;
        ctx.font = "25px Arial";
        ctx.fillStyle = averageColor("#00BFFF", "#000000");
        ctx.fillText("Controls:",WIDTH/2-375,HEIGHT/2-150);
        ctx.fillText("Press space to pause and unpause",WIDTH/2-375,HEIGHT/2-110);
        ctx.fillText("Hold shift and then click to make a planet",WIDTH/2-375,HEIGHT/2+10);
        ctx.fillText("While holding shift, use the up and down keys to change mass",WIDTH/2-375,HEIGHT/2+50);
        ctx.fillText("While holding shift, click and drag to give a planet velocity",WIDTH/2-375,HEIGHT/2+90);
        ctx.fillText("While paused, right click on a planet to edit it",WIDTH/2-375,HEIGHT/2-70);
        ctx.fillText("While paused, double click to zoom in",WIDTH/2-375,HEIGHT/2-30);
        ctx.fillText("More features to be added soon!",WIDTH/2-375,HEIGHT/2+130);
        ctx.globalAlpha = 1;
    }
    drawCursor();
}
function pressed(code){
    if (code==32){
        tutorial = false;
        PAUSE = !PAUSE;
        menu = [null, null];
        velocity_animation = 0;
    }
}
</script>
</head>
<body bgcolor = "#000000">
<body onload="startGame()">
    <canvas id="GameCanvas" style="cursor:none;position:absolute;left:0;right:0;top:0;bottom:0;background-color:#000000;padding-left:0;padding-right:0;margin-left:auto;margin-right:auto;margin-top:auto;margin-bottom:auto;display:block;">
</body>
</html>
